{#모달창에서 주소 검색하면 지역 선택칸에 채워짐#}
<!DOCTYPE html>
{% load static %}
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>흙토람 - 노지 밭 물사용 처방</title>
  <style>
    .container { max-width: 900px; margin: 0 auto; padding: 1em;
      border: 1px solid #e0e0e0; border-radius: 0; }
    nav { margin-bottom: 1em; }
    .nav-menu { display: inline-block; position: relative; }
    .nav-link, .dropdown-link {
      color: #222; text-decoration: none; padding: 4px 13px; font-size: 1.03em; transition: background 0.15s;
    }
    .nav-link:hover, .dropdown-link:hover {
      background: #f5eee5; color: #222; border-radius: 6px;
    }
    .dropdown-content {
      display: none; position: absolute; left: 0; min-width: 190px; background: #fff;
      box-shadow: 0 6px 18px 0 rgba(120,30,180,0.11); border: 1px solid #dedede;
      border-radius: 8px; z-index: 100; padding: 0.3em 0;
    }
    .dropdown-content a {
      display: block; padding: 12px 18px; font-size: 1em; white-space: nowrap;
      color: #222; background: transparent; transition: background 0.17s, color 0.17s;
    }
    .dropdown-content a:hover { background: #f5eee5; color: #222; }
    .nav-menu:hover .dropdown-content {
      display: block; animation: slideDown 0.18s cubic-bezier(.38,.1,.49,.94);
    }
    .form-box {
      background: #faf9f7;
      border: 1px solid #e0e0e0;
      padding: 1.2em 1.5em;
      margin-bottom: 1.4em;
      border-radius: 0;
    }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-12px);} to { opacity: 1; transform: translateY(0);} }
    .form-row { margin: 0.5em 0; }
    select, input[type="date"], input[type="text"] { border:1px solid #bcb69e; background:#fff; height:38px;  font-size:1em; padding:0 10px;
      min-width:110px; margin-right:0.5em; box-sizing:border-box; }
    .button { padding: 0.4em 1em; border: none; background: #6c615e; color: #fff; cursor: pointer; }
    .button.default { background: #ccc; color: #333; }
    .info { color: red; margin-top: 0.5em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #aaa; padding: 0.5em; text-align: center; }
    #report { margin-top: 2em; }
    .result-address { font-weight: bold; margin: 1em 0 0.4em 2px; color: #222; font-size: 1.05em; }
    @media (max-width: 600px) {
      nav { font-size: 0.98em; }
      .dropdown-content { min-width: 145px; }
    }
    .latlon-inline {
      display: inline-block;
      vertical-align: middle;
      margin-left: 18px;
      color: #232;
      font-size: 0.98em;
    }
    .search-address-row input[type="text"] {min-width:200px;}
    /* -------------------- 주소 모달(쿠팡 스타일) -------------------- */
    .modal-bg { position: fixed; z-index: 5000; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(36,36,36,0.22); display:none; }
    .modal-postcode {
      background: #fff; border-radius: 8px;
      width: 500px; max-width: 95vw; margin: 140px auto 0 auto;
      box-shadow: 0 8px 34px 0 rgba(50,50,60,0.18);
      position: relative; padding-bottom:18px;
      animation: modal-pop 0.17s; min-height:420px;
    }
    @keyframes modal-pop { from{ opacity:0; transform: translateY(-40px);} to{ opacity:1; transform:translateY(0); } }
    .modal-postcode-header {
      font-size: 1.15em; font-weight: 600; text-align:center; padding: 18px 20px 11px 20px; border-bottom: 1px solid #ececec;
      position: relative;
    }
    .modal-postcode-close {
      position: absolute; right: 19px; top: 18px; font-size: 1.7em; color: #888; cursor: pointer;
      font-family: Arial, "Noto Sans KR", sans-serif;
      font-weight: 400;
    }
    .modal-postcode-searchbox {
      display: flex; align-items: center;
      margin: 24px 24px 0 24px; padding: 0;
      gap: 0;
    }
    .modal-postcode-searchbox input[type="text"] {
      flex: 1 1 0; height:44px;
      border: 2px solid #3683d6;
      border-radius: 7px 7px 7px 7px;
      font-size: 1.07em;
      padding: 0 16px;
      box-sizing: border-box;
      outline: none;
      background: #fff;
      color: #263a61;
      font-weight: 500;
      letter-spacing: -0.01em;
      transition: border 0.2s;
      min-width: 0;
    }
    .modal-postcode-searchbox input[type="text"]:focus {
      border-color: #2372c7;
    }
    .modal-postcode-search-btn {
      width: 44px; height:44px; min-width:44px;
      border:none; outline:none; padding:0;
      border-radius: 7px 7px 7px 7px;
      background: #3683d6;
      display: flex; align-items: center; justify-content: center;
      cursor:pointer;
      box-shadow:0 1px 4px 0 rgba(60,120,200,0.09);
      transition: background 0.16s;
      border: 2px solid #3683d6;
      border-left: none;
      margin-left: 0;
    }
    .modal-postcode-search-btn:hover {
      background: #2462a8;
    }
    /* ----- 스프라이트 아이콘 ----- */
    .icon {
      display: inline-block;
      background-image: url("{% static 'images/icon.png' %}");
      background-repeat: no-repeat;
      vertical-align: middle;
    }
    .icon1 { width: 18px; height: 17px; background-position: 0px 0px; filter: invert(1) brightness(9); }
    .modal-postcode-tip {
       color: #252525; border-radius:7px; padding:13px 15px 11px 14px; font-size:0.98em; margin:0 22px 10px 22px;}
    .modal-postcode-tip strong { color:#3683d6; }
    @media (max-width:540px){
      .modal-postcode { width:99vw; margin-top:24vw;}
      .modal-postcode-searchbox {margin:7vw 7vw 0 7vw;}
      .modal-postcode-tip {margin:0 7vw 10px 7vw;}
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
  $(function(){
    // ----------- 모달 주소검색(쿠팡 스타일) -----------
    $('#address-search-btn').on('click', function(){
      $('#modal-postcode-bg').fadeIn(100);
      $('#modal-postcode-input').val('').focus();
    });

    // 모달 내 닫기(X), 바깥 클릭 시 닫기
    $('.modal-postcode-close, #modal-postcode-bg').on('click', function(e){
      if (e.target === this) $('#modal-postcode-bg').fadeOut(80);
    });
    // ESC 닫기
    $(document).on('keydown', function(e){
      if(e.key==='Escape') $('#modal-postcode-bg').fadeOut(80);
    });

    // ------ 모달 내 검색버튼(돋보기) 클릭시 입력값 전달 ------
    $('.modal-postcode-search-btn').on('click', function(e){
      e.preventDefault();
      const val = $('#modal-postcode-input').val().trim();
      if (!val) { $('#modal-postcode-input').focus(); return; }
      // 입력값을 메인 주소 입력창에 복사
      $('#address-input').val(val);
      $('#modal-postcode-bg').fadeOut(80);
      $('#address-input').focus();
    });
    // 모달에서 엔터 눌러도 검색 버튼 동작
    $('#modal-postcode-input').on('keypress', function(e){
      if(e.which === 13){
        $('.modal-postcode-search-btn').click();
        return false;
      }
    });

    // -------------- 이하 기존 기능들 그대로 --------------
    const cropMap = {
      '01':['옥수수','콩','보리'],
      '02':['땅콩','참깨'],
      '03':['감자','고구마']
    };
    const stageInfoMap = {
      '유묘기':         { period:'10/10~10/31', waterTon:5.25, dailyTon:0.19 },
      '분얼기':         { period:'11/01~12/10', waterTon:5.77, dailyTon:0.14 },
      '생육재생기':     { period:'02/10~02/28', waterTon:6.26, dailyTon:0.21 },
      '분얼 및 신장기': { period:'03/01~04/20', waterTon:22.17, dailyTon:0.43 },
      '출수 및 등숙기': { period:'04/21~05/10', waterTon:10.95, dailyTon:0.55 }
    };

    $('#crop_gbn').on('change', function(){
      const arr = cropMap[$(this).val()] || [];
      $('#crop').html('<option value="">작물</option>')
        .append(arr.map(n => `<option>${n}</option>`));
    });

    $('#exam_day').on('change', function(){
      const d = $(this).val() || '―';
      $('#recommended').text('권장 파종·정식시기: ' + d);
    });

    $('#search').on('click', function(){
      const D = id => $(`#${id} option:selected`).text() || $(`#${id}`).val() || '-';
      let inputAddr = $('#address-input').val().trim();

      if (!inputAddr) {
        alert('주소를 입력하세요.');
        return;
      }
      $.ajax({
        url: "{% url 'water:get_latlon' %}",
        data: { q: inputAddr },
        dataType: "json",
        success: function(res){
          let parcel_addr = res.parcel_addr || "-";
          let road_addr = res.road_addr || "-";
          let addrObj = {
            parcel_addr: parcel_addr,
            road_addr: road_addr
          };
          $('#address-confirmed').val(JSON.stringify(addrObj));
          $('#result').html(
            `<div class="result-address">
              <div>지번주소: ${parcel_addr}</div>
              <div>도로명주소: ${road_addr}</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>작물</th>
                  <th>파종·정식시기</th>
                  <th>기상정보</th>
                  <th>관수방법</th>
                  <th>관수면적(㎡)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>${D('crop')}</td>
                  <td>${$('#exam_day').val() || '-'}</td>
                  <td>${D('weather')}</td>
                  <td>${D('irrigation')}</td>
                  <td>${$('#area').val() || '-'}</td>
                </tr>
              </tbody>
            </table>`
          );
          let totalW = 0, totalD = 0, rows = '';
          $.each(stageInfoMap, (s, v) => {
            totalW += v.waterTon; totalD += v.dailyTon;
            rows += `<tr>
              <td>${s}</td>
              <td>${v.period}</td>
              <td>${v.waterTon.toFixed(2)}</td>
              <td>${v.dailyTon.toFixed(2)}</td>
            </tr>`;
          });
          rows += `<tr>
            <td>계</td><td></td>
            <td>${totalW.toFixed(2)}</td>
            <td>${totalD.toFixed(2)}</td>
          </tr>`;
          $('#report').html(
            `<table>
              <thead>
                <tr>
                  <th>생육단계</th>
                  <th>생육기간<br>(월/일)</th>
                  <th>물 필요량<br>(톤/100m²)</th>
                  <th>일별 물 필요량<br>(톤/day)</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>`
          );
        },
        error: function(xhr){
          $('#result').html('<div class="result-address" style="color:red;">주소 정보 조회에 실패했습니다.</div>');
          $('#report').empty();
        }
      });
    });

    $('#reset').on('click', function(){
      $('#address-input, #lat, #lon, #address-confirmed').val('');
      $('#crop_gbn, #crop, #exam_day, #weather, #irrigation, #area').val('');
      $('#recommended').text('권장 파종·정식시기: ―');
      $('#result, #report').empty();
    });
  });
  </script>
</head>
<body>
  <div class="container">
    <!-- nav -->
    <nav>
      <a class="nav-link" href="{% url 'main-index' %}">홈</a> |
      <a class="nav-link" href="{% url 'water:water' %}">물사용처방</a> |
      <span class="nav-menu">
        <a class="nav-link" href="javascript:void(0)">비료사용처방</a>
        <div class="dropdown-content">
          <a class="dropdown-link" href="{% url 'fertilizer:prescription' %}">비료사용처방</a>
          <a class="dropdown-link" href="{% url 'fertilizer:experience' %}">비료사용처방 체험하기</a>
          <a class="dropdown-link" href="{% url 'fertilizer:standard' %}">비료 표준사용량 처방</a>
        </div>
      </span>
    </nav>
    <!-- //nav -->

    <h1>노지 밭 물사용 처방</h1>
    <form id="water-form" onsubmit="return false;">
      <div class="form-box">
        <div class="form-row search-address-row">
          <label>· 지역</label>
          <input type="text" id="address-input" placeholder="지번·도로명·건물명 입력" />
          <button type="button" class="button default" id="address-search-btn">주소검색</button>
          <input type="hidden" id="lat">
          <input type="hidden" id="lon">
          <input type="hidden" id="address-confirmed" />
        </div>
        <div class="form-row">
          <label>· 작물</label>
          <select id="crop_gbn">
            <option value="">작물분류</option>
            <option value="01">곡류</option>
            <option value="02">유지작물</option>
            <option value="03">서류</option>
          </select>
          <select id="crop"><option value="">작물</option></select>
        </div>
        <div class="form-row">
          <label>· 파종·정식시기</label>
          <input type="date" id="exam_day" />
          <span id="recommended">권장 파종·정식시기: ―</span>
        </div>
        <div class="form-row">
          <label>· 기상정보</label>
          <select id="weather">
            <option value="">평년선택</option>
            <option>최근3년</option>
            <option>최근10년</option>
          </select>
        </div>
        <div class="form-row">
          <label>· 관수방법</label>
          <select id="irrigation">
            <option value="">관수방법</option>
            <option>점적관수</option>
            <option>스프링클러</option>
            <option>분수호스</option>
            <option>고랑관수</option>
          </select>
        </div>
        <div class="form-row">
          <label>· 노지밭면적(m²)</label>
          <input type="text" id="area" style="width:80px;" />
        </div>
        <div class="info">* 기상정보 데이터 산정에 따라 조회내용표출이 다소 지연될 수 있습니다.</div>
        <div class="form-row">
          <button type="button" id="search" class="button">검색</button>
          <button type="reset" id="reset" class="button default">초기화</button>
        </div>
      </div>
    </form>
    <div id="result"></div>
    <div id="report"></div>
  </div>
  <!-- 주소/우편번호 모달(쿠팡스타일) -->
  <div class="modal-bg" id="modal-postcode-bg">
    <div class="modal-postcode">
      <div class="modal-postcode-header">
        우편번호 찾기
        <span class="modal-postcode-close" title="닫기">&times;</span>
      </div>
      <div class="modal-postcode-searchbox">
        <input type="text" id="modal-postcode-input" placeholder="도로명, 건물명, 번지 입력" autocomplete="off" />
        <button type="button" class="modal-postcode-search-btn" title="검색">
          <span class="icon icon1"></span>
        </button>
      </div>
      <div class="modal-postcode-tip">
        <div style="font-weight:600; margin-bottom:5px;">우편번호 통합검색 Tip</div>
        <ul style="padding-left:14px; margin:0 0 0.5em 0;">
          <li><strong>동/읍/면/리 + 번지</strong> (예: 왕궁면 동용리 444)</li>
          <li><strong>도로명 + 건물번호</strong> (예: 고산로 488)</li>
          <li><strong>건물명, 아파트명</strong> (예: 국립농업과학원)</li>
        </ul>
      </div>
    </div>
  </div>
</body>
</html>
