<!DOCTYPE html>
{% load static %}
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>작물별 비료 표준사용량 처방 </title>
  <meta name="viewport" content="width=1024,user-scalable=no">
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/module.css' %}">
  <style>
    .container { max-width: 950px; margin: 0 auto; padding: 1em; }
    h1, h2 { margin-bottom: .6em; }
    .form-row { margin-bottom: .7em; }
    label { font-weight: bold; margin-right: .6em; }
    select, input[type="text"] { margin-right: .5em; }
    .button { padding: .4em 1em; background: #6c615e; color: #fff; border: none; cursor: pointer; }
    .button.reset { background: #ccc; color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #aaa; padding: .5em; text-align: center; }
    .section { display: flex; flex-wrap: wrap; gap: 2em; }
    .section > div { flex: 1; min-width: 350px; }
    .recommend-box { margin-top: 1.2em; border: 1px solid #e0e0e0; padding: 1em; border-radius: 6px; }
    .radio-row label { font-weight: normal; margin-right: .8em; }
    .dummy-msg { font-size: 0.93em; color: #cc6600; margin: .6em 0 .2em 0; }
    .fert-section2 { margin-top: 1em; border: 1px solid #aaa; background: #fff; border-radius: 7px; padding: 1.2em 1.2em 0.7em 1.2em; }
    .fert-section2 h4 { margin-top: 0; font-size: 1.12em; color: #444; }
    .fert-row { display: flex; align-items: center; gap: 1.1em; margin-bottom: 0.9em; }
    .fert-row label { font-weight: normal; }
    .fert-row input[type="text"], .fert-row select { width: 70px; }
    .fert-row select { width: auto; }
    .fert-row input[type="checkbox"] { margin-left: 10px; }
    .fert-section2 .result { color: #222 !important; font-weight: bold; }
    @media (max-width: 820px) {
      .section, .fert-row-table tr { display: block; }
      .fert-row-table td, .fert-row-table th { display: block; width: 100%; }
      .fert-section2 { padding: 0.9em 0.5em 0.6em 0.5em; }
      .fert-row { flex-direction: column; align-items: flex-start; gap: 0.3em; }
    }
    /* 폼 두 줄 나누기용 */
    .area-row { display: flex; align-items: center; margin-bottom: 0.7em; gap: 1.7em; }
    .area-label { min-width: 96px; }
    .unit-radio { margin-left: 7px; }
    @media (max-width: 620px) {
      .area-row { flex-direction: column; align-items: flex-start; gap: 0.2em; }
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
  // --------------------- 더미 함수 영역 ----------------------
  function getDummyCropTypes() {
    return {
      '00': '곡류(벼)',  '01': '곡류(기타)', '02': '유지류', '03': '서류', '04': '과채류',
      '05': '근채류', '06': '인경채류', '07': '경엽채소류', '08': '산채류',
      '09': '과수', '10': '약용작물', '11': '화훼류', '12': '사료작물', '13': '기타'
    };
  }
  function getDummyCropList(type) {
    const map = {
      '00': ['벼'], '01': ['보리','밀','수수'],
      '04': ['토마토', '오이', '고추'], '09': ['사과', '배'],
      '11': ['장미', '국화'], '13': ['기타']
    };
    return map[type] || [];
  }
  function dummyComponentAmount(component, stage) {
    const base = { N: 5, P: 4.5, K: 4, n: 4, p: 0, k: 1.7 };
    let v = Math.random() * 1.2 + (base[component] || 3);
    if (stage === 'post') v *= 0.7;
    return v.toFixed(1);
  }
  function dummyRecommendation(component, stage) {
    let v = Math.random() * 0.7 + (stage==='pre'? 0.7 : 0.3);
    return v.toFixed(1);
  }
  function dummyFertilizerRank(stage) {
    if(stage==='pre') return [
      ['복합비료(21-17-17)', '인산칼리맞춤1호(20-18-15)', '야라밀라(12-11-18)']
    ];
    return [
      ['엔케이도BS(28-0-12)', '원샷NK(25-0-10)', '맞춤추비27호(20-0-9)']
    ];
  }
  function dummyCompoundPrescription(stage, npk) {
    return {
      total: (Math.random() * 1.3 + 17).toFixed(1),
      total2: (Math.random() * 0.7 + 1.5).toFixed(1),
      total3: (Math.random() * 0.4 + 0.6).toFixed(1),
      msg: stage==='pre' ? '복합비료는 21-17-17, 인산칼리맞춤1호 등 추천' : '엔케이도BS, 원샷NK 추천'
    };
  }
  // 단위 변환
  function pyToM2(py) {
    return (parseFloat(py) * 3.3058).toFixed(2);
  }
  function m2ToPy(m2) {
    return (parseFloat(m2) / 3.3058).toFixed(2);
  }
  // --------------------------------------------------------

  $(function(){
    // 작물유형 채우기
    const types = getDummyCropTypes();
    $.each(types, function(val, name){
      $('#crop_gbn').append(new Option(name, val));
    });

    $('#crop_gbn').on('change', function(){
      const list = getDummyCropList(this.value);
      $('#crop_cd').empty().append(new Option('선택', ''));
      list.forEach(n => $('#crop_cd').append(new Option(n, n)));
    });

    // 단위 변환 (m2 <-> 평)
    let currentUnit = 'm2';
    $('input[name="area_gb"]').on('change', function(){
      let areaVal = $('#area').val();
      if (!areaVal || isNaN(areaVal)) return;
      if ($(this).parent().text().includes('㎡') && currentUnit !== 'm2') {
        $('#area').val(pyToM2(areaVal));
        currentUnit = 'm2';
      } else if ($(this).parent().text().includes('평') && currentUnit !== 'py') {
        $('#area').val(m2ToPy(areaVal));
        currentUnit = 'py';
      }
    });

    // 검색 클릭
    $('#search').on('click', function(){
      const cropType = $('#crop_gbn').val();
      const crop = $('#crop_cd').val();
      let area = parseFloat($('#area').val()||'');
      if (!cropType || !crop || !area) {
        alert('모든 항목을 선택·입력하세요.');
        return;
      }
      // 성분량
      let pre_n = dummyComponentAmount('N','pre');
      let pre_p = dummyComponentAmount('P','pre');
      let pre_k = dummyComponentAmount('K','pre');
      let post_n = dummyComponentAmount('N','post');
      let post_p = dummyComponentAmount('P','post');
      let post_k = dummyComponentAmount('K','post');
      // 추천량
      let pre_yoso = dummyRecommendation('N','pre');
      let pre_phos = dummyRecommendation('P','pre');
      let pre_kali = dummyRecommendation('K','pre');
      let post_yoso = dummyRecommendation('N','post');
      let post_phos = dummyRecommendation('P','post');
      let post_kali = dummyRecommendation('K','post');
      // 복합비료 추천
      let preRanks = dummyFertilizerRank('pre')[0];
      let postRanks = dummyFertilizerRank('post')[0];
      // 복합비료 처방(임의값)
      let preFert = dummyCompoundPrescription('pre',{N:pre_n,P:pre_p,K:pre_k,q:20});
      let postFert = dummyCompoundPrescription('post',{N:post_n,P:post_p,K:post_k,q:20});

      // === 복합비료 처방 세로형(테두리만) ===
      let fertColTable = `
        <div class="fert-section2">
          <h4>밑거름 복합비료 처방(kg/실면적)</h4>
          <div class="fert-row">
            <label>비종선택
              <select>
                <option>복합비료(21-17-17)</option>
                <option>인산칼리맞춤1호(20-18-15)</option>
              </select>
            </label>
            <label><input type="checkbox"> 사용자 직접 입력</label>
          </div>
          <div class="fert-row">
            <label>질소(%) <input type="text" value="21"></label>
            <label>인산(%) <input type="text" value="17"></label>
            <label>칼리(%) <input type="text" value="17"></label>
            <label>비료(1포대당) <input type="text" value="20">kg</label>
          </div>
          <div class="fert-row">
            <label>복합비료 추천량 <input type="text" class="result" value="${preFert.total}"></label>
          </div>
          <div class="fert-row">
            <label>인산 추가필요량 <input type="text" value="${preFert.total2}"></label>
            <label>칼리 추가필요량 <input type="text" value="${preFert.total3}"></label>
          </div>
        </div>
        <div class="fert-section2">
          <h4>웃거름 복합비료 처방(kg/실면적)</h4>
          <div class="fert-row">
            <label>비종선택
              <select>
                <option>엔케이도BS(28-0-12)</option>
                <option>원샷NK(25-0-10)</option>
              </select>
            </label>
            <label><input type="checkbox"> 사용자 직접 입력</label>
          </div>
          <div class="fert-row">
            <label>질소(%) <input type="text" value="18"></label>
            <label>인산(%) <input type="text" value="0"></label>
            <label>칼리(%) <input type="text" value="16"></label>
            <label>비료(1포대당) <input type="text" value="20">kg</label>
          </div>
          <div class="fert-row">
            <label>복합비료 추천량 <input type="text" class="result" value="${postFert.total}"></label>
          </div>
          <div class="fert-row">
            <label>인산 추가필요량 <input type="text" value="${postFert.total2}"></label>
            <label>칼리 추가필요량 <input type="text" value="${postFert.total3}"></label>
          </div>
        </div>
      `;

      $('#results').html(`
      <div class="section">
        <div>
          <h3>성분량(kg/10a)</h3>
          <table>
            <thead><tr><th></th><th>질소</th><th>인산</th><th>칼리</th></tr></thead>
            <tbody>
              <tr><th>밑거름</th><td>${pre_n}</td><td>${pre_p}</td><td>${pre_k}</td></tr>
              <tr><th>웃거름</th><td>${post_n}</td><td>${post_p}</td><td>${post_k}</td></tr>
            </tbody>
          </table>
        </div>
        <div>
          <h3>추천량(kg/실면적)</h3>
          <table>
            <thead><tr><th></th><th>요소</th><th>용성인비</th><th>염화칼리</th></tr></thead>
            <tbody>
              <tr><th>밑거름</th><td>${pre_yoso}</td><td>${pre_phos}</td><td>${pre_kali}</td></tr>
              <tr><th>웃거름</th><td>${post_yoso}</td><td>${post_phos}</td><td>${post_kali}</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="recommend-box">
        <h4>복합비료(시중유통비료) 추천 순위</h4>
        <table>
          <tr>
            <th rowspan="3" style="width:110px;">추천 비료(%)</th>
            <th>구분</th>
            <th>1순위</th>
            <th>2순위</th>
            <th>3순위</th>
          </tr>
          <tr>
            <td>밑거름</td>
            <td>${preRanks[0]}</td><td>${preRanks[1]}</td><td>${preRanks[2]}</td>
          </tr>
          <tr>
            <td>웃거름</td>
            <td>${postRanks[0]}</td><td>${postRanks[1]}</td><td>${postRanks[2]}</td>
          </tr>
        </table>
        <div class="dummy-msg">※ 임의 더미 추천입니다</div>
      </div>

      <div class="recommend-box">
        <h4>복합비료 처방방식</h4>
        <div class="radio-row">
          <label><input type="radio" name="presc_mode" checked> 질소기준처방</label>
          <label><input type="radio" name="presc_mode"> 인산기준처방</label>
          <label><input type="radio" name="presc_mode"> 칼리기준처방</label>
        </div>
      </div>

      <div>
        ${fertColTable}
      </div>

      <div class="recommend-box">
        <h4>복합비료(시중유통비료) 추천량</h4>
        <table>
          <tr>
            <th>밑거름 추천량</th>
            <td>${preFert.msg}</td>
          </tr>
          <tr>
            <th>웃거름 추천량</th>
            <td>${postFert.msg}</td>
          </tr>
        </table>
      </div>
      `);
    });

    $('#reset').on('click', function(){
      $('#crop_gbn').val('');
      $('#crop_cd').empty().append(new Option('선택', ''));
      $('#area').val('');
      $('#results').empty();
    });
  });
  </script>
</head>
<body>
  <div class="container">
    <h1>작물별 비료 표준사용량 처방 <span style="font-size:0.6em; color:#888"></span></h1>
    <div class="form-row">
      <label class="area-label">작물 선택</label>
      <select id="crop_gbn">
        <option value="">선택</option>
      </select>
      <select id="crop_cd">
        <option value="">선택</option>
      </select>
    </div>
    <div class="form-row area-row">
      <label class="area-label">대상지면적</label>
      <input type="text" id="area" style="width:90px;" value="">
      <label class="unit-radio"><input type="radio" name="area_gb" checked> 제곱미터(㎡)</label>
      <label class="unit-radio"><input type="radio" name="area_gb"> 평</label>
    </div>
    <div class="form-row">
      <button id="search" class="button">검색</button>
      <button id="reset" class="button reset">초기화</button>
    </div>
    <div id="results"></div>
  </div>
</body>
</html>
