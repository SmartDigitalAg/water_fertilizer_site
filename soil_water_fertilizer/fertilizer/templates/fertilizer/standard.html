<!DOCTYPE html>
{% load static %}
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>작물별 비료 표준사용량 처방</title>
  <meta name="viewport" content="width=1024,user-scalable=no">
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/module.css' %}">
  <style>
    .container { max-width: 950px; margin: 0 auto; padding: 1em; }
    h1, h2 { margin-bottom: .6em; }
    nav { margin-bottom: 1em; }
.nav-menu { display: inline-block; position: relative; }
.nav-link, .dropdown-link {
  color: #6c2394;
  text-decoration: none;
  padding: 4px 13px;
  font-size: 1.03em;
  transition: background 0.15s;
}
.nav-link:hover, .dropdown-link:hover {
  background: #f7eafd;
  color: #47215a;
  border-radius: 6px;
}
.dropdown-content {
  display: none;
  position: absolute;
  left: 0;
  min-width: 190px;
  background: #fff;
  box-shadow: 0 6px 18px 0 rgba(120,30,180,0.11);
  border: 1px solid #dedede;
  border-radius: 8px;
  z-index: 100;
  padding: 0.3em 0;
}
.dropdown-content a {
  display: block;
  padding: 12px 18px;
  margin: 0;
  font-size: 1em;
  white-space: nowrap;
  background: transparent;
  color: #592db3;
  transition: background 0.17s, color 0.17s;
}
.dropdown-content a:hover {
  background: #f1e5fd;
  color: #3d176b;
}
.nav-menu:hover .dropdown-content {
  display: block;
  animation: slideDown 0.18s cubic-bezier(.38,.1,.49,.94);
}
@keyframes slideDown {
  from { opacity: 0; transform: translateY(-12px);}
  to   { opacity: 1; transform: translateY(0);}
}
@media (max-width: 600px) {
  nav { font-size: 0.98em; }
  .dropdown-content { min-width: 145px; }
}
    .form-row { margin-bottom: .7em; }
    label { font-weight: bold; margin-right: .6em; }
    select, input[type="text"] { margin-right: .5em; }
    .button { padding: .4em 1em; background: #6c615e; color: #fff; border: none; cursor: pointer; }
    .button.reset { background: #ccc; color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #aaa; padding: .5em; text-align: center; }
    .section { display: flex; flex-wrap: wrap; gap: 2em; }
    .section > div { flex: 1; min-width: 350px; }
    .section-wrap { border: 1px solid #e0e0e0; border-radius: 6px; padding: 1em; margin-bottom: 1.3em; background: #fff; }
    .recommend-box { margin-top: 1.2em; border: 1px solid #e0e0e0; padding: 1em; border-radius: 6px; }
    .radio-row label { font-weight: normal; margin-right: .8em; }
    .dummy-msg { font-size: 0.93em; color: #cc6600; margin: .6em 0 .2em 0; }
    .fert-section2 { margin-top: 1em; border: 1px solid #e0e0e0; background: #fff; border-radius: 7px; padding: 1.2em 1.2em 0.7em 1.2em; }
    .fert-section2 h4, .fert-section2 h3 { margin-top: 0; font-size: 1.12em; color: #444; }
    .fert-row { display: flex; align-items: center; gap: 1.1em; margin-bottom: 0.9em; }
    .fert-row label { font-weight: normal; }
    .fert-row input[type="text"], .fert-row select { width: 70px; }
    .fert-row select { width: auto; }
    .fert-row input[type="checkbox"] { margin-left: 10px; }
    .fert-section2 .result { color: #222 !important; font-weight: bold; }
    @media (max-width: 820px) {
      .section, .fert-row-table tr { display: block; }
      .fert-row-table td, .fert-row-table th { display: block; width: 100%; }
      .fert-section2 { padding: 0.9em 0.5em 0.6em 0.5em; }
      .fert-row { flex-direction: column; align-items: flex-start; gap: 0.3em; }
      .section-wrap { padding: 0.7em 0.3em 0.7em 0.3em; }
    }
    .area-row { display: flex; align-items: center; margin-bottom: 0.7em; gap: 1.7em; }
    .area-label { min-width: 96px; }
    .unit-radio { margin-left: 7px; }
    @media (max-width: 620px) {
      .area-row { flex-direction: column; align-items: flex-start; gap: 0.2em; }
    }
    .fert-table input[type="text"] { width: 60px; }
    .fert-table label { margin-right: 0; font-weight: normal; }
    .fert-table .warn { color: #cc3300; font-size: 0.95em; font-weight: normal; text-align: left; }
  </style>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
  // --------------------- 기존 함수/더미 ----------------------
  function getDummyCropTypes() {
    return {
      '00': '곡류(벼)',  '01': '곡류(기타)', '02': '유지류', '03': '서류', '04': '과채류',
      '05': '근채류', '06': '인경채류', '07': '경엽채소류', '08': '산채류',
      '09': '과수', '10': '약용작물', '11': '화훼류', '12': '사료작물', '13': '기타'
    };
  }
  function getDummyCropList(type) {
    const map = {
      '00': ['벼'], '01': ['보리','밀','수수'],
      '04': ['토마토', '오이', '고추'], '09': ['사과', '배'],
      '11': ['장미', '국화'], '13': ['기타']
    };
    return map[type] || [];
  }
  function dummyComponentAmount(component, stage) {
    const base = { N: 5, P: 4.5, K: 4, n: 4, p: 0, k: 1.7 };
    let v = Math.random() * 1.2 + (base[component] || 3);
    if (stage === 'post') v *= 0.7;
    return v.toFixed(1);
  }
  function dummyRecommendation(component, stage) {
    let v = Math.random() * 0.7 + (stage==='pre'? 0.7 : 0.3);
    return v.toFixed(1);
  }
  function dummyFertilizerRank(stage) {
    if(stage==='pre') return [
      ['복합비료(21-17-17)', '인산칼리맞춤1호(20-18-15)', '야라밀라(12-11-18)']
    ];
    return [
      ['엔케이도BS(28-0-12)', '원샷NK(25-0-10)', '맞춤추비27호(20-0-9)']
    ];
  }
  function dummyCompoundPrescription(stage, npk) {
    return {
      total: (Math.random() * 1.3 + 2).toFixed(1),
      total2: (Math.random() * 0.7 + 0.1).toFixed(1),
      total3: (Math.random() * 0.4 + 0.1).toFixed(1)
    };
  }
  function pyToM2(py) {
    return (parseFloat(py) * 3.3058).toFixed(2);
  }
  function m2ToPy(m2) {
    return (parseFloat(m2) / 3.3058).toFixed(2);
  }
  // --------------------- 여기까지 기존 함수/더미 ----------------------
  $(function(){
    // 기존 기능(작물, 면적 등)
    const types = getDummyCropTypes();
    $.each(types, function(val, name){
      $('#crop_gbn').append(new Option(name, val));
    });
    $('#crop_gbn').on('change', function(){
      const list = getDummyCropList(this.value);
      $('#crop_cd').empty().append(new Option('선택', ''));
      list.forEach(n => $('#crop_cd').append(new Option(n, n)));
    });
    let currentUnit = 'm2';
    $('input[name="area_gb"]').on('change', function(){
      let areaVal = $('#area').val();
      if (!areaVal || isNaN(areaVal)) return;
      if ($(this).parent().text().includes('㎡') && currentUnit !== 'm2') {
        $('#area').val(pyToM2(areaVal));
        currentUnit = 'm2';
      } else if ($(this).parent().text().includes('평') && currentUnit !== 'py') {
        $('#area').val(m2ToPy(areaVal));
        currentUnit = 'py';
      }
    });

    // 처방 비종 데이터(예시)
    const PRE_FERTS = [
      {name:'흙사랑21', N:21, P:6, K:8, disp:'흙사랑21 (21-6-8)'},
      {name:'복합비료(21-17-17)', N:21, P:17, K:17, disp:'복합비료(21-17-17)'},
      {name:'인산칼리맞춤1호', N:20, P:18, K:15, disp:'인산칼리맞춤1호 (20-18-15)'}
    ];
    const POST_FERTS = [
      {name:'엔케이804', N:18, P:0, K:14, disp:'엔케이804 (18-0-14)'},
      {name:'엔케이도BS(28-0-12)', N:28, P:0, K:12, disp:'엔케이도BS(28-0-12)'},
      {name:'원샷NK(25-0-10)', N:25, P:0, K:10, disp:'원샷NK(25-0-10)'}
    ];

    function makeRecommendText(fert, amount, pAdd, kAdd) {
      let txt = `${fert.disp} ${amount}kg`;
      let extra = [];
      if (pAdd && Number(pAdd) > 0) extra.push(`인산 ${pAdd}kg`);
      if (kAdd && Number(kAdd) > 0) extra.push(`칼리 ${kAdd}kg`);
      if (extra.length > 0) txt += ', ' + extra.join(', ');
      txt += '을 주십시오.';
      return txt;
    }

    $('#search').on('click', function(){
      // 기존 추천결과 테이블 로직 ------------------------
      const cropType = $('#crop_gbn').val();
      const crop = $('#crop_cd').val();
      let area = parseFloat($('#area').val()||'');
      if (!cropType || !crop || !area) {
        alert('모든 항목을 선택·입력하세요.');
        return;
      }
      let pre_n = dummyComponentAmount('N','pre');
      let pre_p = dummyComponentAmount('P','pre');
      let pre_k = dummyComponentAmount('K','pre');
      let post_n = dummyComponentAmount('N','post');
      let post_p = dummyComponentAmount('P','post');
      let post_k = dummyComponentAmount('K','post');
      let pre_yoso = dummyRecommendation('N','pre');
      let pre_phos = dummyRecommendation('P','pre');
      let pre_kali = dummyRecommendation('K','pre');
      let post_yoso = dummyRecommendation('N','post');
      let post_phos = dummyRecommendation('P','post');
      let post_kali = dummyRecommendation('K','post');
      let preRanks = dummyFertilizerRank('pre')[0];
      let postRanks = dummyFertilizerRank('post')[0];
      let preFert = dummyCompoundPrescription('pre',{N:pre_n,P:pre_p,K:pre_k,q:20});
      let postFert = dummyCompoundPrescription('post',{N:post_n,P:post_p,K:post_k,q:20});

      let html = `
      <div class="section-wrap">
        <div class="section">
          <div>
            <h3>&#9654; 성분량(kg/10a)</h3>
            <table>
              <thead><tr><th></th><th>질소</th><th>인산</th><th>칼리</th></tr></thead>
              <tbody>
                <tr><th>밑거름</th><td>${pre_n}</td><td>${pre_p}</td><td>${pre_k}</td></tr>
                <tr><th>웃거름</th><td>${post_n}</td><td>${post_p}</td><td>${post_k}</td></tr>
              </tbody>
            </table>
          </div>
          <div>
            <h3>&#9654; 추천량(kg/실면적)</h3>
            <table>
              <thead><tr><th></th><th>요소</th><th>용성인비</th><th>염화칼리</th></tr></thead>
              <tbody>
                <tr><th>밑거름</th><td>${pre_yoso}</td><td>${pre_phos}</td><td>${pre_kali}</td></tr>
                <tr><th>웃거름</th><td>${post_yoso}</td><td>${post_phos}</td><td>${post_kali}</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="recommend-box">
        <h3>&#9654; 복합비료(시중유통비료) 추천 순위</h3>
        <table>
          <tr>
            <th rowspan="3" style="width:110px;">추천 비료(%)</th>
            <th></th>
            <th>1순위</th>
            <th>2순위</th>
            <th>3순위</th>
          </tr>
          <tr>
            <td>밑거름</td>
            <td>${preRanks[0]}</td><td>${preRanks[1]}</td><td>${preRanks[2]}</td>
          </tr>
          <tr>
            <td>웃거름</td>
            <td>${postRanks[0]}</td><td>${postRanks[1]}</td><td>${postRanks[2]}</td>
          </tr>
        </table>
        <div class="dummy-msg">※ 임의 더미 추천입니다</div>
      </div>
      <div class="recommend-box">
        <h3>&#9654; 복합비료 처방방식</h3>
        <div class="radio-row">
          <label><input type="radio" name="presc_mode" checked> 질소기준처방(기존방식)</label>
          <label><input type="radio" name="presc_mode"> 인산기준처방</label>
          <label><input type="radio" name="presc_mode"> 칼리기준처방</label>
        </div>
      </div>
      `;

      // ===== 표 형식으로 교체: 밑거름/웃거름 복합비료 처방 입력폼 ======
      let preIdx = 0, postIdx = 0;
      let preF = PRE_FERTS[preIdx], postF = POST_FERTS[postIdx];
      let preAmt = preFert.total, prePAdd = preFert.total2, preKAdd = preFert.total3;
      let postAmt = postFert.total, postPAdd = postFert.total2, postKAdd = postFert.total3;

      html += `
      <div class="fert-section2" id="pre_sec">
        <h3>&#9654; 밑거름 복합비료 처방(kg/실면적)</h3>
        <table class="fert-table">
          <tr>
            <td colspan="6" style="text-align:left;">
              <label>비종선택
                <select id="pre_fert_sel">
                  ${PRE_FERTS.map((f,i)=>`<option value="${i}">${f.disp}</option>`).join('')}
                </select>
              </label>
              <label>
                사용자 직접 입력 <input type="checkbox" id="pre_user">
              </label>
              <span class="warn">&nbsp;※ 질소, 인산 및 칼리 성분을 직접 입력 시 선택하세요.</span>
            </td>
          </tr>
          <tr>
            <td>복합비료 종류(%)</td>
            <td>질소: <input type="text" id="pre_n" value="${preF.N}" readonly></td>
            <td>인산: <input type="text" id="pre_p" value="${preF.P}" readonly></td>
            <td>칼리: <input type="text" id="pre_k" value="${preF.K}" readonly></td>
            <td>비료(1포대당): <input type="text" value="20" style="width:40px;" readonly> kg</td>
          </tr>
          <tr>
            <td>복합비료 추천량</td>
            <td colspan="4" style="text-align:left;">
              <input type="text" id="pre_amt" value="${preAmt}">
            </td>
          </tr>
          <tr>
            <td>인산 추가필요량</td>
            <td colspan="2"><input type="text" id="pre_pAdd" value="${prePAdd}"></td>
            <td>칼리 추가필요량</td>
            <td colspan="2"><input type="text" id="pre_kAdd" value="${preKAdd}"></td>
          </tr>
        </table>
      </div>
      <div class="fert-section2" id="post_sec">
        <h3>&#9654; 웃거름 복합비료 처방(kg/실면적)</h3>
        <table class="fert-table">
          <tr>
            <td colspan="6" style="text-align:left;">
              <label>비종선택
                <select id="post_fert_sel">
                  ${POST_FERTS.map((f,i)=>`<option value="${i}">${f.disp}</option>`).join('')}
                </select>
              </label>
              <label>
                사용자 직접 입력 <input type="checkbox" id="post_user">
              </label>
              <span class="warn">&nbsp;※ 질소, 인산 및 칼리 성분을 직접 입력 시 선택하세요.</span>
            </td>
          </tr>
          <tr>
            <td>복합비료 종류(%)</td>
            <td>질소: <input type="text" id="post_n" value="${postF.N}" readonly></td>
            <td>인산: <input type="text" id="post_p" value="${postF.P}" readonly></td>
            <td>칼리: <input type="text" id="post_k" value="${postF.K}" readonly></td>
            <td>비료(1포대당): <input type="text" value="20" style="width:40px;" readonly> kg</td>
          </tr>
          <tr>
            <td>복합비료 추천량</td>
            <td colspan="4" style="text-align:left;">
              <input type="text" id="post_amt" value="${postAmt}">
            </td>
          </tr>
          <tr>
            <td>인산 추가필요량</td>
            <td colspan="2"><input type="text" id="post_pAdd" value="${postPAdd}"></td>
            <td>칼리 추가필요량</td>
            <td colspan="2"><input type="text" id="post_kAdd" value="${postKAdd}"></td>
          </tr>
        </table>
      </div>
      <div class="recommend-box">
        <h3>&#9654; 복합비료(시중유통비료) 추천량</h3>
        <table>
          <tr>
            <th>밑거름 추천량</th>
            <td id="rec_pre"></td>
          </tr>
          <tr>
            <th>웃거름 추천량</th>
            <td id="rec_post"></td>
          </tr>
        </table>
      </div>
      `;

      $('#results').html(html);

      // === 동적 추천문구 실시간 연동 ===
      function updateRecommendText() {
        // 밑거름
        let fIdx = $('#pre_user').is(':checked') ? null : Number($('#pre_fert_sel').val());
        let fert = fIdx !== null ? PRE_FERTS[fIdx] : {
          disp: `사용자정의 (${ $('#pre_n').val() }-${ $('#pre_p').val() }-${ $('#pre_k').val() })`,
          N: $('#pre_n').val(), P: $('#pre_p').val(), K: $('#pre_k').val()
        };
        let amount = $('#pre_amt').val();
        let pAdd = $('#pre_pAdd').val();
        let kAdd = $('#pre_kAdd').val();
        let preText = makeRecommendText(fert, amount, pAdd, kAdd);

        // 웃거름
        let pfIdx = $('#post_user').is(':checked') ? null : Number($('#post_fert_sel').val());
        let pfert = pfIdx !== null ? POST_FERTS[pfIdx] : {
          disp: `사용자정의 (${ $('#post_n').val() }-${ $('#post_p').val() }-${ $('#post_k').val() })`,
          N: $('#post_n').val(), P: $('#post_p').val(), K: $('#post_k').val()
        };
        let postAmt = $('#post_amt').val();
        let postPAdd = $('#post_pAdd').val();
        let postKAdd = $('#post_kAdd').val();
        let postText = makeRecommendText(pfert, postAmt, postPAdd, postKAdd);

        $('#rec_pre').text(preText);
        $('#rec_post').text(postText);
      }

      $('#pre_user').on('change', function() {
        const on = $(this).is(':checked');
        $('#pre_fert_sel').prop('disabled', on);
        $('#pre_n, #pre_p, #pre_k').prop('readonly', !on);
        updateRecommendText();
      });
      $('#post_user').on('change', function() {
        const on = $(this).is(':checked');
        $('#post_fert_sel').prop('disabled', on);
        $('#post_n, #post_p, #post_k').prop('readonly', !on);
        updateRecommendText();
      });
      $('#pre_fert_sel').on('change', function() {
        let f = PRE_FERTS[this.value];
        $('#pre_n').val(f.N);
        $('#pre_p').val(f.P);
        $('#pre_k').val(f.K);
        updateRecommendText();
      });
      $('#post_fert_sel').on('change', function() {
        let f = POST_FERTS[this.value];
        $('#post_n').val(f.N);
        $('#post_p').val(f.P);
        $('#post_k').val(f.K);
        updateRecommendText();
      });
      $('#pre_amt, #pre_pAdd, #pre_kAdd, #pre_n, #pre_p, #pre_k, #pre_fert_sel, #pre_user').on('input change', updateRecommendText);
      $('#post_amt, #post_pAdd, #post_kAdd, #post_n, #post_p, #post_k, #post_fert_sel, #post_user').on('input change', updateRecommendText);
      updateRecommendText();
    });

    $('#reset').on('click', function(){
      $('#crop_gbn').val('');
      $('#crop_cd').empty().append(new Option('선택', ''));
      $('#area').val('');
      $('#results').empty();
    });
  });
  </script>
</head>
<body>
  <div class="container">
    <nav>
  <a class="nav-link" href="{% url 'home' %}">홈</a> |
  <a class="nav-link" href="{% url 'water:index' %}">물사용처방</a> |
  <span class="nav-menu">
    <a class="nav-link" href="javascript:void(0)">비료사용처방 ▼</a>
    <div class="dropdown-content">
      <a class="dropdown-link" href="{% url 'fertilizer:prescription' %}">비료사용처방</a>
      <a class="dropdown-link" href="{% url 'fertilizer:experience' %}">비료사용처방 체험하기</a>
      <a class="dropdown-link" href="{% url 'fertilizer:standard' %}">비료 표준사용량 처방</a>
    </div>
  </span>
</nav>
    <h1>작물별 비료 표준사용량 처방 <span style="font-size:0.6em; color:#888"></span></h1>
    <div class="form-row">
      <label class="area-label">작물 선택</label>
      <select id="crop_gbn">
        <option value="">선택</option>
      </select>
      <select id="crop_cd">
        <option value="">선택</option>
      </select>
    </div>
    <div class="form-row area-row">
      <label class="area-label">대상지면적</label>
      <input type="text" id="area" style="width:90px;" value="">
      <label class="unit-radio"><input type="radio" name="area_gb" checked> 제곱미터(㎡)</label>
      <label class="unit-radio"><input type="radio" name="area_gb"> 평</label>
    </div>
    <div class="form-row">
      <button id="search" class="button">검색</button>
      <button id="reset" class="button reset">초기화</button>
    </div>
    <div id="results"></div>
  </div>
</body>
</html>
