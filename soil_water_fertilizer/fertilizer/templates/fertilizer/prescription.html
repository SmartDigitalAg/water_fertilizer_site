<!DOCTYPE html>
{% load static %}
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>비료사용처방</title>
  <meta name="viewport" content="width=1024,user-scalable=no">
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/module.css' %}">
  <style>
    body { background: #fcfcfc; }
    .container {
      max-width: 980px;
      margin: 40px auto 0 auto;
      padding: 1.5em 2em;
      background: #fff;
      border-radius: 0;
      border: 1px solid #e0e0e0;
    }
    nav { margin-bottom: 1em; }
.nav-menu { display: inline-block; position: relative; }
.nav-link, .dropdown-link {
  color: #6c2394;
  text-decoration: none;
  padding: 4px 13px;
  font-size: 1.03em;
  transition: background 0.15s;
}
.nav-link:hover, .dropdown-link:hover {
  background: #f7eafd;
  color: #47215a;
  border-radius: 6px;
}
.dropdown-content {
  display: none;
  position: absolute;
  left: 0;
  min-width: 190px;
  background: #fff;
  box-shadow: 0 6px 18px 0 rgba(120,30,180,0.11);
  border: 1px solid #dedede;
  border-radius: 8px;
  z-index: 100;
  padding: 0.3em 0;
}
.dropdown-content a {
  display: block;
  padding: 12px 18px;
  margin: 0;
  font-size: 1em;
  white-space: nowrap;
  background: transparent;
  color: #592db3;
  transition: background 0.17s, color 0.17s;
}
.dropdown-content a:hover {
  background: #f1e5fd;
  color: #3d176b;
}
.nav-menu:hover .dropdown-content {
  display: block;
  animation: slideDown 0.18s cubic-bezier(.38,.1,.49,.94);
}
@keyframes slideDown {
  from { opacity: 0; transform: translateY(-12px);}
  to   { opacity: 1; transform: translateY(0);}
}
@media (max-width: 600px) {
  nav { font-size: 0.98em; }
  .dropdown-content { min-width: 145px; }
}
    h1 { margin-bottom: 1.1em; font-size: 2em; font-weight: bold; }

    .form-box {
      background: #faf9f7;
      border: 1px solid #e0e0e0;
      border-radius: 0;
      padding: 1.2em 1.5em;
      margin-bottom: 1.4em;
    }
    .form-row {
      margin-bottom: 1em;
      display: flex;
      align-items: center;
      gap: 1.1em;
    }
    .form-row label, .sub-form-row label {
      min-width: 90px;
      width: 90px;
      font-weight: bold;
      color: #333;
      text-align: left;
      display: inline-block;
    }
    .form-row select,
    .form-row input[type="text"],
    .sub-form-row select,
    .sub-form-row input[type="text"] {
      border: 1px solid #bcb69e;
      border-radius: 0;
      background: #fff;
      height: 38px;
      font-size: 1em;
      box-sizing: border-box;
      padding: 0 10px;
      min-width: 150px;
    }
    #jibun_sel, #date_sel {
      min-width: 210px !important;
      width: 210px !important;
    }
    .form-box > div[style] > #search {
      background: #6f462a;
      color: #fff;
      border: 0;
      border-radius: 0;
      font-weight: bold;
      font-size: 1em;
      width: 90px;
      height: 38px;
      transition: background 0.15s;
      margin-left: 0.7em;
    }
    .form-box > div[style] > #search:hover {
      background: #54341b;
    }
    .form-row .btn-search,
    .sub-form-row .btn-search,
    .sub-form-row .btn-lookup {
      background: #fff;
      color: #222;
      border: 2px solid #222;
      border-radius: 0;
      font-weight: 500;
      padding: 6px 22px;
      font-size: 1em;
      height: 38px;
      min-width: 85px;
      box-sizing: border-box;
      transition: background 0.2s, color 0.2s;
    }
    .form-row .btn-search:hover,
    .sub-form-row .btn-search:hover,
    .sub-form-row .btn-lookup:hover {
      background: #f6f1ea;
      color: #000;
    }
    .sub-form-row {
      margin-bottom: 1em;
      display: flex;
      align-items: center;
      gap: 1.1em;
    }
    .sub-form-row select {
      width: 110px;
      min-width: 110px;
      height: 38px;
      border-radius: 0;
      border: 1px solid #bcb69e;
      background: #fff;
      font-size: 1em;
      padding: 0 10px;
      box-sizing: border-box;
    }
    .sub-form-row input[type="text"] {
      width: 110px !important;
      min-width: 0;
      height: 38px;
      border-radius: 0;
      border: 1px solid #bcb69e;
      padding: 0 10px;
      font-size: 1em;
      box-sizing: border-box;
    }
    .sub-form-row .btn-lookup {
      margin-left: 8px;
    }
    .form-row > *, .sub-form-row > * {
      margin-right: 0 !important;
    }
    @media (max-width: 720px) {
      .container { padding: 1em 0.3em; }
      .form-row, .sub-form-row { flex-direction: column; align-items: flex-start; gap: 0.4em; }
      .form-row label, .sub-form-row label { min-width: 0; width: auto; }
      .form-row select, .sub-form-row select, .sub-form-row input[type="text"] { width: 100% !important; margin-right: 0; }
      .form-row .btn, .sub-form-row .btn { width: 100%; }
      #jibun_sel, #date_sel { min-width: 100% !important; width: 100% !important; }
    }
    .chem-title { font-weight: bold; font-size: 1em; margin-bottom: 10px; margin-top: 25px; }
    .chem-table { width: 100%; border-collapse: collapse; margin-top: 0.5em; }
    .chem-table th, .chem-table td { border: 1px solid #e0e0e0; padding: 7px 4px; text-align: center; }
    .chem-table th { background: #faf9f5; }
    .presc-tables-row { display: flex; gap: 24px; margin-bottom: 18px; }
    .presc-table-col { flex: 1 1 0; min-width: 260px; }
    .presc-table-col h3 { font-size: 1.07em; font-weight: bold; margin: 0 0 8px 0; color: #222; }
    @media (max-width: 900px) {
      .presc-tables-row { flex-direction: column; gap: 10px; }
      .presc-table-col { min-width: 0; }
    }
    /* ----- 복합비료 처방 표 배경색 제거 (수정됨) ----- */
    .fert-section2 {
      margin:30px 0 18px 0;
      border:1px solid #f2e6da;
      background:none !important; /* << 여기만 변경 */
      padding:16px 12px;
    }
    .fert-section2 h3 { font-size:1.08em; font-weight: bold; margin:0 0 8px 0; }
    .fert-table { width:100%; border-collapse:collapse; margin-bottom:0.6em; }
    .fert-table td, .fert-table th { border:1px solid #e0e0e0; padding:7px 4px; }
    .fert-table th { background: #faf9f5; }
    .fert-table input[type="text"] { width:55px; text-align:right; }
    .warn { font-size:11px; color:chocolate;}
  </style>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
    // ---- [더미 지역/작물/지번/검정일 연동 데이터] ----
    const sidoList = [
      {code: "52", name: "전북특별자치도"},
      {code: "41", name: "경기도"},
      {code: "48", name: "경상남도"},
      {code: "50", name: "제주특별자치도"}
    ];
    const sggMap = {
      "52": [
        {code: "01", name: "완주군"}, {code: "02", name: "익산시"}, {code: "03", name: "전주시"}
      ],
      "41": [{code: "01", name: "수원시"}, {code: "02", name: "용인시"}],
      "48": [{code: "01", name: "창원시"}, {code: "02", name: "진주시"}],
      "50": [{code: "01", name: "제주시"}, {code: "02", name: "서귀포시"}]
    };
    const umdMap = {
      "52-01": ["고산면", "비봉면", "봉동읍"],
      "52-02": ["금마면", "낭산면"],
      "52-03": ["덕진구", "완산구"],
      "41-01": ["장안구", "영통구"],
      "41-02": ["기흥구", "처인구"],
      "48-01": ["성산구", "진해구"],
      "48-02": ["문산읍", "이반성면"],
      "50-01": ["구좌읍", "애월읍"],
      "50-02": ["중문동", "대정읍"]
    };
    const riMap = {
      "52-01-고산면": ["율곡리", "화정리"],
      "52-01-비봉면": ["수선리", "이전리"],
      "52-03-덕진구": ["송천동", "인후동"],
      "41-01-장안구": ["정자동", "이목동"],
      "48-01-성산구": ["반지동", "내동"],
      "50-01-구좌읍": ["평대리", "행원리"]
    };
    function hasRi(sido, sgg, umd) {
      return !!riMap[`${sido}-${sgg}-${umd}`];
    }
    const cropTypeList = [
      {code: "00", name: "곡류(벼)"},
      {code: "04", name: "과채류"},
      {code: "09", name: "과수"},
      {code: "11", name: "화훼류"}
    ];
    const cropMap = {
      "00": ["벼", "보리"],
      "04": ["토마토", "오이"],
      "09": ["사과", "배"],
      "11": ["장미", "국화"]
    };
    // 지번-일자 연동 더미
    const jibunList = [
      "[밭] 338-1", "[밭] 68-1", "[논] 179", "[밭] 621-8"
    ];
    const dateList = [
      "2022-07-25", "2021-06-11", "2020-10-05"
    ];
    const jibunToDates = {
      "[밭] 338-1": ["2022-07-25", "2021-06-11"],
      "[밭] 68-1": ["2020-10-05"],
      "[논] 179": ["2022-07-25"],
      "[밭] 621-8": ["2021-06-11"]
    };

    // 복합비료 더미
    const PRE_FERTS = [
      {disp: "복합비료(21-17-17)", N: 21, P: 17, K: 17},
      {disp: "인산칼리맞춤1호(20-18-15)", N: 20, P: 18, K: 15},
      {disp: "야라밀라(12-11-18)", N: 12, P: 11, K: 18}
    ];
    const POST_FERTS = [
      {disp: "엔케이도BS(28-0-12)", N: 28, P: 0, K: 12},
      {disp: "원샷NK(25-0-10)", N: 25, P: 0, K: 10},
      {disp: "맞춤추비27호(20-0-9)", N: 20, P: 0, K: 9}
    ];

    // ==== 더미값 함수 (모두 유지) ====
    function getNBasal() { return "6.5"; }
    function getPBasal() { return "15.6"; }
    function getKBasal() { return "11.1"; }
    function getNTop()   { return "0.0"; }
    function getPTop()   { return "0.0"; }
    function getKTop()   { return "0.0"; }
    function getUreaBasal()   { return "3.8"; }
    function getSuperPBasal() { return "21.1"; }
    function getKClBasal()    { return "5.0"; }
    function getUreaTop()     { return "0.0"; }
    function getSuperPTop()   { return "0.0"; }
    function getKClTop()      { return "0.0"; }
    function getBasalFert1() { return "복합비료(21-17-17)(21-17-17)"; }
    function getBasalFert2() { return "인산칼리맞춤1호(20-18-15)"; }
    function getBasalFert3() { return "야라밀라(12-11-18)"; }
    function getTopFert1()   { return "엔케이도BS(28-0-12)"; }
    function getTopFert2()   { return "원샷NK(25-0-10)"; }
    function getTopFert3()   { return "맞춤추비27호(20-0-9)"; }
    function getFertN()  { return "21.0"; }
    function getFertP()  { return "17.0"; }
    function getFertK()  { return "17.0"; }
    function getFertQy() { return "20"; }
    function getPreFertTotal()   { return ""; }
    function getPreFertTotal2()  { return ""; }
    function getPreFertTotal3()  { return ""; }
    function getLimingMtril() { return ""; }
    function getCowDrop()   { return "25"; }
    function getPigDrop()   { return "14"; }
    function getFowlDrop()  { return "26"; }
    function getSawdust()   { return "21"; }

    // 표 전체 렌더링 (기존 + 신규 UI)
    function renderPrescriptionResultTable() {
      // 밑거름
      let preF = PRE_FERTS[0];
      let preAmt = "20", prePAdd = "0.0", preKAdd = "0.0";
      // 웃거름
      let postF = POST_FERTS[0];
      let postAmt = "10", postPAdd = "0.0", postKAdd = "0.0";

      return `
  <div class="presc-result-wrap" style="margin-top:36px;">
    <div class="presc-tables-row">
      <div class="presc-table-col">
        <h3>&#9654; 성분량(kg/10a)</h3>
        <table class="item_c chem-table">
          <thead>
            <tr><th></th><th>질소</th><th>인산</th><th>칼리</th></tr>
          </thead>
          <tbody>
            <tr><th>밑거름</th><td>${getNBasal()}</td><td>${getPBasal()}</td><td>${getKBasal()}</td></tr>
            <tr><th>웃거름</th><td>${getNTop()}</td><td>${getPTop()}</td><td>${getKTop()}</td></tr>
          </tbody>
        </table>
      </div>
      <div class="presc-table-col">
        <h3>&#9654; 추천량(kg/실면적)</h3>
        <table class="item_c chem-table">
          <thead>
            <tr><th></th><th>요소</th><th>용성인비</th><th>염화칼리</th></tr>
          </thead>
          <tbody>
            <tr><th>밑거름</th><td>${getUreaBasal()}</td><td>${getSuperPBasal()}</td><td>${getKClBasal()}</td></tr>
            <tr><th>웃거름</th><td>${getUreaTop()}</td><td>${getSuperPTop()}</td><td>${getKClTop()}</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <h3> &#9654; 복합비료(시중유통비료) 추천 순위</h3>
    <table class="item_c chem-table">
      <thead>
        <tr><th>추천 비료<br>(%)</th><th>1 순위</th><th>2 순위</th><th>3 순위</th></tr>
      </thead>
      <tbody>
        <tr>
          <th>밑거름</th>
          <td>${getBasalFert1()}</td>
          <td>${getBasalFert2()}</td>
          <td>${getBasalFert3()}</td>
        </tr>
        <tr>
          <th>웃거름</th>
          <td>${getTopFert1()}</td>
          <td>${getTopFert2()}</td>
          <td>${getTopFert3()}</td>
        </tr>
      </tbody>
    </table>
    <div style="color:#7d6a53; margin-top:8px; font-size:0.96em;">
      ※ 위 추천비료는 기준값에서 질소, 인산, 칼리 순으로 근접한 비료가 선정되었습니다.<br>
      ※ 밑거름, 웃거름 복합비료(시중유통비료) 처방 시 추천순위를 클릭하시거나 아래화면에서 비종 선택 및 사용자 직접입력을 클릭하신 후 비료성분량을 입력하세요.
    </div>
    <h3> &#9654; 복합비료 처방방식</h3>
    <table class="item_a" style="background:#f2f2f2;">
      <tbody>
        <tr>
          <th style="padding-left:20px;">처방방식 선택</th>
          <td style="padding-left:15px;">
            <input type="radio" name="prscrptn_cnd" value="1" checked>질소기준처방(기존방식)
            <input type="radio" name="prscrptn_cnd" value="2">인산기준처방
            <input type="radio" name="prscrptn_cnd" value="3">칼리기준처방
          </td>
        </tr>
      </tbody>
    </table>
    <!-- 밑거름 복합비료 (배경색 제거됨) -->
    <div class="fert-section2" id="pre_sec">
      <h3>&#9654; 밑거름 복합비료 처방(kg/실면적)</h3>
      <table class="fert-table">
        <tr>
          <td colspan="6" style="text-align:left;">
            <label>비종선택
              <select id="pre_fert_sel">
                ${PRE_FERTS.map((f,i)=>`<option value="${i}">${f.disp}</option>`).join('')}
              </select>
            </label>
            <label>
              사용자 직접 입력 <input type="checkbox" id="pre_user">
            </label>
            <span class="warn">&nbsp;※ 질소, 인산 및 칼리 성분을 직접 입력 시 선택하세요.</span>
          </td>
        </tr>
        <tr>
          <td>복합비료 종류(%)</td>
          <td>질소: <input type="text" id="pre_n" value="${preF.N}" readonly></td>
          <td>인산: <input type="text" id="pre_p" value="${preF.P}" readonly></td>
          <td>칼리: <input type="text" id="pre_k" value="${preF.K}" readonly></td>
          <td>비료(1포대당): <input type="text" value="20" style="width:40px;" readonly> kg</td>
        </tr>
        <tr>
          <td>복합비료 추천량</td>
          <td colspan="4" style="text-align:left;">
            <input type="text" id="pre_amt" value="${preAmt}">
          </td>
        </tr>
        <tr>
          <td>인산 추가필요량</td>
          <td colspan="2"><input type="text" id="pre_pAdd" value="${prePAdd}"></td>
          <td>칼리 추가필요량</td>
          <td colspan="2"><input type="text" id="pre_kAdd" value="${preKAdd}"></td>
        </tr>
      </table>
    </div>
    <!-- 웃거름 복합비료 (배경색 제거됨) -->
    <div class="fert-section2" id="post_sec">
      <h3>&#9654; 웃거름 복합비료 처방(kg/실면적)</h3>
      <table class="fert-table">
        <tr>
          <td colspan="6" style="text-align:left;">
            <label>비종선택
              <select id="post_fert_sel">
                ${POST_FERTS.map((f,i)=>`<option value="${i}">${f.disp}</option>`).join('')}
              </select>
            </label>
            <label>
              사용자 직접 입력 <input type="checkbox" id="post_user">
            </label>
            <span class="warn">&nbsp;※ 질소, 인산 및 칼리 성분을 직접 입력 시 선택하세요.</span>
          </td>
        </tr>
        <tr>
          <td>복합비료 종류(%)</td>
          <td>질소: <input type="text" id="post_n" value="${postF.N}" readonly></td>
          <td>인산: <input type="text" id="post_p" value="${postF.P}" readonly></td>
          <td>칼리: <input type="text" id="post_k" value="${postF.K}" readonly></td>
          <td>비료(1포대당): <input type="text" value="20" style="width:40px;" readonly> kg</td>
        </tr>
        <tr>
          <td>복합비료 추천량</td>
          <td colspan="4" style="text-align:left;">
            <input type="text" id="post_amt" value="${postAmt}">
          </td>
        </tr>
        <tr>
          <td>인산 추가필요량</td>
          <td colspan="2"><input type="text" id="post_pAdd" value="${postPAdd}"></td>
          <td>칼리 추가필요량</td>
          <td colspan="2"><input type="text" id="post_kAdd" value="${postKAdd}"></td>
        </tr>
      </table>
    </div>
    <h3> &#9654; 석회질비료 선택</h3>
    <table class="item_b">
      <tbody>
        <tr>
          <th>석회질비료선택</th>
          <td>
            <select style="width:160px;"><option>선택</option></select>
          </td>
        </tr>
      </tbody>
    </table>
    <div style="color: chocolate; margin-top: 5px;">
      ※ pH가 6.5 이상이거나 석회소요량이 0인 검정자료의 경우 석회질비료를 선택할 수 없습니다.
    </div>
    <h3> &#9654; 혼합가축분퇴비 처방(kg/실면적)</h3>
    <table class="item_b">
      <tbody>
        <tr>
          <th>가축분 혼합 비율</th>
          <td>
            <label>우분 :</label><input type="text" style="width:60px; text-align:right" value="${getCowDrop()}">(%)&nbsp;&nbsp;
            <label>돈분 :</label><input type="text" style="width:60px; text-align:right" value="${getPigDrop()}">(%)&nbsp;&nbsp;
            <label>계분 :</label><input type="text" style="width:60px; text-align:right" value="${getFowlDrop()}">(%)&nbsp;&nbsp;
            <label>톱밥 :</label><input type="text" style="width:60px; text-align:right" value="${getSawdust()}">(%)&nbsp;&nbsp;
          </td>
        </tr>
      </tbody>
    </table>
    <div style="color: chocolate; margin-top: 5px;">
      ※ 퇴비에 가축분 혼합비율이 표기되어 있을 경우 입력하세요.(미입력시 평균값 적용)<br>
      &nbsp;&nbsp;&nbsp;&nbsp;우분, 돈분, 계분, 톱밥 중 한 종류가 50% 이상일 경우에는 기존의 우분, 돈분, 계분퇴비, 톱밥 추천량을 참고하면 됩니다.<br>
      &nbsp;&nbsp;&nbsp;&nbsp;유기물 적정범위를 초과할 경우에는 가축분퇴비 추천량이 계산되지 않습니다.
    </div>
    <div style="margin:18px 0 6px 0">
      <a href="#" class="button colorOrange">처방서 보기</a>
      <a href="#" class="button colorWhite">초기화</a>
    </div>
  </div>
      `;
    }

    // 지역, 작물 등 UI연동 (기존과 동일)
    function showChemResultIfReady() {
      let sido = $('#sido option:selected').text();
      let sidoVal = $('#sido').val();
      let sgg = $('#sgg option:selected').text();
      let sggVal = $('#sgg').val();
      let umd = $('#umd option:selected').text();
      let umdVal = $('#umd').val();
      let riVal = $('#ri').val();
      let ri = $('#ri option:selected').text();

      if (!sidoVal || !sggVal || !umdVal) {
        $('#results').html('');
        $('.sub-form-row-wrap').remove();
        return;
      }
      if (hasRi(sidoVal, sggVal, umd)) {
        if (!riVal) { $('#results').html(''); $('.sub-form-row-wrap').remove(); return; }
      } else {
        ri = '';
      }
      let locArr = [sido, sgg, umd, ri].filter(x=>x&&x.indexOf("선택")<0);
      let locText = locArr.join(' ');

      let chem = { ph: "5.9", organic: "37.1", phosph: "451.0", k: "1.4", ca: "5.4", mg: "1.7", ec: "1.3", silica: "65.2" };
      let resHtml = `
        <div class="chem-title">※ ${locText} 화학성 평균</div>
        <table class="chem-table">
          <thead>
            <tr>
              <th rowspan="2">pH<br>(1:5)</th>
              <th rowspan="2">유기물<br>(g/kg)</th>
              <th rowspan="2">유효인산<br>(mg/kg)</th>
              <th colspan="3">치환성 양이온(cmol<sup>+</sup>/kg)</th>
              <th rowspan="2">전기전도도<br>(dS/m)</th>
              <th rowspan="2">유효규산<br>(mg/kg)</th>
            </tr>
            <tr>
              <th>칼륨</th>
              <th>칼슘</th>
              <th>마그네슘</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${chem.ph}</td>
              <td>${chem.organic}</td>
              <td>${chem.phosph}</td>
              <td>${chem.k}</td>
              <td>${chem.ca}</td>
              <td>${chem.mg}</td>
              <td>${chem.ec}</td>
              <td>${chem.silica}</td>
            </tr>
          </tbody>
        </table>
      `;
      $('#results').html(resHtml);

      if ($('.sub-form-row-wrap').length === 0) {
        let subHtml = `
        <div class="sub-form-row-wrap">
          <div class="sub-form-row">
            <label>지번조회</label>
            <select style="width:110px;"><option>일반</option><option>산</option></select>
            <input style="width:110px;" type="text" maxlength="4">
            <span>-</span>
            <input style="width:110px;" type="text" maxlength="4">
            <button type="button" class="btn btn-lookup">조회</button>
          </div>
          <div class="sub-form-row">
            <label>지번선택</label>
            <select id="jibun_sel">
              <option value="">지번 선택</option>
              ${jibunList.map(x=>`<option value="${x}">${x}</option>`).join('')}
            </select>
          </div>
          <div class="sub-form-row">
            <label>토양검정일자</label>
            <select id="date_sel">
              <option value="">일자 선택</option>
              ${dateList.map(x=>`<option value="${x}">${x}</option>`).join('')}
            </select>
          </div>
        </div>`;
        $('.form-row').eq(1).after(subHtml);

        $('#jibun_sel').on('change', function(){
          let jibun = $(this).val();
          let $date = $('#date_sel');
          $date.empty();
          let dates = jibunToDates[jibun] || [];
          if(dates.length > 0){
            for(const d of dates) $date.append(new Option(d, d));
            $date.val(dates[0]);
          } else {
            $date.append('<option value="">일자 선택</option>');
          }
        });
      }
    }

    $(function(){
      for(const s of sidoList) $('#sido').append(new Option(s.name, s.code));
      for(const c of cropTypeList) $('#crop_type').append(new Option(c.name, c.code));
      $('#sido').on('change', function(){
        let sido = this.value;
        $('#sgg').empty().append('<option value="">시/군/구</option>');
        $('#umd').empty().append('<option value="">읍/면/동</option>');
        $('#ri').empty().append('<option value="">리</option>');
        $('.sub-form-row-wrap').remove();
        if(!sido) return;
        for(const s of (sggMap[sido] || [])){
          $('#sgg').append(new Option(s.name, s.code));
        }
        showChemResultIfReady();
      });
      $('#sgg').on('change', function(){
        let sido = $('#sido').val(), sgg = this.value;
        $('#umd').empty().append('<option value="">읍/면/동</option>');
        $('#ri').empty().append('<option value="">리</option>');
        $('.sub-form-row-wrap').remove();
        if(!sido || !sgg) return;
        let list = umdMap[`${sido}-${sgg}`] || [];
        for(const u of list) $('#umd').append(new Option(u, u));
        showChemResultIfReady();
      });
      $('#umd').on('change', function(){
        let sido = $('#sido').val(), sgg = $('#sgg').val(), umd = this.value;
        $('#ri').empty().append('<option value="">리</option>');
        $('.sub-form-row-wrap').remove();
        if(!sido || !sgg || !umd) { showChemResultIfReady(); return; }
        let list = riMap[`${sido}-${sgg}-${umd}`] || [];
        if (list.length > 0) {
          for(const r of list) $('#ri').append(new Option(r, r));
        }
        showChemResultIfReady();
      });
      $('#ri').on('change', function(){
        $('.sub-form-row-wrap').remove();
        showChemResultIfReady();
      });
      $('#crop_type').on('change', function(){
        let list = cropMap[this.value] || [];
        $('#crop_cd').empty().append('<option value="">작물 선택</option>');
        for(const c of list) $('#crop_cd').append(new Option(c, c));
      });
      $('#search').on('click', function(){ showChemResultIfReady(); });
    });

    // 3. 검색 버튼에서 출력
    function handlePrescriptionSearch() {
      let cropType = $('#crop_type').val();
      let cropCd = $('#crop_cd').val();
      let jibun = $('#jibun_sel').val();
      let date = $('#date_sel').val();

      if (!cropType || !cropCd || !jibun || !date) {
        $('#presc_results').html('');
        return;
      }
      $('#presc_results').html(renderPrescriptionResultTable());
    }

    // 기존 검색버튼 이벤트 확장
    $(function() {
      $('#search').off('click').on('click', function() {
        showChemResultIfReady();   // 기존
        handlePrescriptionSearch();// 처방결과
      });
    });
  </script>
</head>
<body>
  <div class="container">
    <nav>
  <a class="nav-link" href="{% url 'home' %}">홈</a> |
  <a class="nav-link" href="{% url 'water:index' %}">물사용처방</a> |
  <span class="nav-menu">
    <a class="nav-link" href="javascript:void(0)">비료사용처방 ▼</a>
    <div class="dropdown-content">
      <a class="dropdown-link" href="{% url 'fertilizer:prescription' %}">비료사용처방</a>
      <a class="dropdown-link" href="{% url 'fertilizer:experience' %}">비료사용처방 체험하기</a>
      <a class="dropdown-link" href="{% url 'fertilizer:standard' %}">비료 표준사용량 처방</a>
    </div>
  </span>
</nav>
    <h1>비료사용처방</h1>
    <div class="form-box">
      <div class="form-row">
        <label>지역</label>
        <select id="sido"><option value="">광역시/도</option></select>
        <select id="sgg"><option value="">시/군/구</option></select>
        <select id="umd"><option value="">읍/면/동</option></select>
        <select id="ri"><option value="">리</option></select>
        <button type="button" class="btn btn-search" onclick="alert('주소검색 더미입니다');">주소검색</button>
      </div>
      <div class="form-row">
        <label>작물</label>
        <select id="crop_type"><option value="">작물유형 선택</option></select>
        <select id="crop_cd"><option value="">작물 선택</option></select>
        <button type="button" class="btn btn-search" onclick="alert('작물명검색 더미입니다');">작물명검색</button>
      </div>
      <div style="text-align:right;padding-top:5px;">
        <button id="search" type="button" class="btn">검색</button>
      </div>
    </div>
    <div id="results"></div>
    <div id="presc_results"></div>
  </div>
</body>
</html>
